<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>samples/BluetoothChat/src/com/example/android/BluetoothChat/DeviceListActivity.java - platform/development - Git at Google</title><link rel="stylesheet" type="text/css" href="//www.google.com/css/go.css" /><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.pZ5FqzM6cPxAflH0va2Ucw.cache.css" /><link rel="stylesheet" type="text/css" href="/+static/gitiles.1WJVkAfC8yZIr9tnmjVI0Q.cache.css" /></head><body><h1><img src="//www.google.com/images/logo_sm.gif" alt="Google" />Git</h1><div class="menu"> <a href="https://www.google.com/a/SelectSession?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/development/%2B/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/DeviceListActivity.java">Sign in</a> </div><div class="breadcrumbs"><a href="/?format=HTML">android</a> / <a href="/platform/development/">platform/development</a> / <a href="/platform/development/+/eclair-passion-release">eclair-passion-release</a> / <a href="/platform/development/+/eclair-passion-release/">.</a> / <a href="/platform/development/+/eclair-passion-release/samples">samples</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat">BluetoothChat</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src?autodive=0">src</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com?autodive=0">com</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example?autodive=0">example</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android?autodive=0">android</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat">BluetoothChat</a> / DeviceListActivity.java</div><div class="sha1">blob: fa722a202987ad748f8c8a0cd83dc2981e5fd7c0 [<a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/DeviceListActivity.java">file</a>] [<a href="/platform/development/+log/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/DeviceListActivity.java">log</a>] [<a href="/platform/development/+blame/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/DeviceListActivity.java">blame</a>]</div><ol class="prettyprint"><li><a name="1"></a><span class="com">/*</span></li><li><a name="2"></a><span class="com"> * Copyright (C) 2009 The Android Open Source Project</span></li><li><a name="3"></a><span class="com"> *</span></li><li><a name="4"></a><span class="com"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></li><li><a name="5"></a><span class="com"> * you may not use this file except in compliance with the License.</span></li><li><a name="6"></a><span class="com"> * You may obtain a copy of the License at</span></li><li><a name="7"></a><span class="com"> *</span></li><li><a name="8"></a><span class="com"> *      http://www.apache.org/licenses/LICENSE-2.0</span></li><li><a name="9"></a><span class="com"> *</span></li><li><a name="10"></a><span class="com"> * Unless required by applicable law or agreed to in writing, software</span></li><li><a name="11"></a><span class="com"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></li><li><a name="12"></a><span class="com"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></li><li><a name="13"></a><span class="com"> * See the License for the specific language governing permissions and</span></li><li><a name="14"></a><span class="com"> * limitations under the License.</span></li><li><a name="15"></a><span class="com"> */</span></li><li><a name="16"></a></li><li><a name="17"></a><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">example</span><span class="pun">.</span><span class="pln">android</span><span class="pun">.</span><span class="typ">BluetoothChat</span><span class="pun">;</span></li><li><a name="18"></a></li><li><a name="19"></a><span class="kwd">import</span><span class="pln"> java</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Set</span><span class="pun">;</span></li><li><a name="20"></a></li><li><a name="21"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">app</span><span class="pun">.</span><span class="typ">Activity</span><span class="pun">;</span></li><li><a name="22"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">bluetooth</span><span class="pun">.</span><span class="typ">BluetoothAdapter</span><span class="pun">;</span></li><li><a name="23"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">bluetooth</span><span class="pun">.</span><span class="typ">BluetoothDevice</span><span class="pun">;</span></li><li><a name="24"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">BroadcastReceiver</span><span class="pun">;</span></li><li><a name="25"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Context</span><span class="pun">;</span></li><li><a name="26"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Intent</span><span class="pun">;</span></li><li><a name="27"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">IntentFilter</span><span class="pun">;</span></li><li><a name="28"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Bundle</span><span class="pun">;</span></li><li><a name="29"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">;</span></li><li><a name="30"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">View</span><span class="pun">;</span></li><li><a name="31"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">Window</span><span class="pun">;</span></li><li><a name="32"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">View</span><span class="pun">.</span><span class="typ">OnClickListener</span><span class="pun">;</span></li><li><a name="33"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">AdapterView</span><span class="pun">;</span></li><li><a name="34"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">ArrayAdapter</span><span class="pun">;</span></li><li><a name="35"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">Button</span><span class="pun">;</span></li><li><a name="36"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">ListView</span><span class="pun">;</span></li><li><a name="37"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">TextView</span><span class="pun">;</span></li><li><a name="38"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">AdapterView</span><span class="pun">.</span><span class="typ">OnItemClickListener</span><span class="pun">;</span></li><li><a name="39"></a></li><li><a name="40"></a><span class="com">/**</span></li><li><a name="41"></a><span class="com"> * This Activity appears as a dialog. It lists any paired devices and</span></li><li><a name="42"></a><span class="com"> * devices detected in the area after discovery. When a device is chosen</span></li><li><a name="43"></a><span class="com"> * by the user, the MAC address of the device is sent back to the parent</span></li><li><a name="44"></a><span class="com"> * Activity in the result Intent.</span></li><li><a name="45"></a><span class="com"> */</span></li><li><a name="46"></a><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">DeviceListActivity</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Activity</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="47"></a><span class="pln">    </span><span class="com">// Debugging</span></li><li><a name="48"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> TAG </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;DeviceListActivity&quot;</span><span class="pun">;</span></li><li><a name="49"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> D </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="50"></a></li><li><a name="51"></a><span class="pln">    </span><span class="com">// Return Intent extra</span></li><li><a name="52"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> EXTRA_DEVICE_ADDRESS </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;device_address&quot;</span><span class="pun">;</span></li><li><a name="53"></a></li><li><a name="54"></a><span class="pln">    </span><span class="com">// Member fields</span></li><li><a name="55"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">BluetoothAdapter</span><span class="pln"> mBtAdapter</span><span class="pun">;</span></li><li><a name="56"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln"> mPairedDevicesArrayAdapter</span><span class="pun">;</span></li><li><a name="57"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln"> mNewDevicesArrayAdapter</span><span class="pun">;</span></li><li><a name="58"></a></li><li><a name="59"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="60"></a><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="61"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span></li><li><a name="62"></a></li><li><a name="63"></a><span class="pln">        </span><span class="com">// Setup the window</span></li><li><a name="64"></a><span class="pln">        requestWindowFeature</span><span class="pun">(</span><span class="typ">Window</span><span class="pun">.</span><span class="pln">FEATURE_INDETERMINATE_PROGRESS</span><span class="pun">);</span></li><li><a name="65"></a><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">device_list</span><span class="pun">);</span></li><li><a name="66"></a></li><li><a name="67"></a><span class="pln">        </span><span class="com">// Set result CANCELED incase the user backs out</span></li><li><a name="68"></a><span class="pln">        setResult</span><span class="pun">(</span><span class="typ">Activity</span><span class="pun">.</span><span class="pln">RESULT_CANCELED</span><span class="pun">);</span></li><li><a name="69"></a></li><li><a name="70"></a><span class="pln">        </span><span class="com">// Initialize the button to perform device discovery</span></li><li><a name="71"></a><span class="pln">        </span><span class="typ">Button</span><span class="pln"> scanButton </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Button</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">button_scan</span><span class="pun">);</span></li><li><a name="72"></a><span class="pln">        scanButton</span><span class="pun">.</span><span class="pln">setOnClickListener</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">OnClickListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="73"></a><span class="pln">            </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onClick</span><span class="pun">(</span><span class="typ">View</span><span class="pln"> v</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="74"></a><span class="pln">                doDiscovery</span><span class="pun">();</span></li><li><a name="75"></a><span class="pln">                v</span><span class="pun">.</span><span class="pln">setVisibility</span><span class="pun">(</span><span class="typ">View</span><span class="pun">.</span><span class="pln">GONE</span><span class="pun">);</span></li><li><a name="76"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="77"></a><span class="pln">        </span><span class="pun">});</span></li><li><a name="78"></a></li><li><a name="79"></a><span class="pln">        </span><span class="com">// Initialize array adapters. One for already paired devices and</span></li><li><a name="80"></a><span class="pln">        </span><span class="com">// one for newly discovered devices</span></li><li><a name="81"></a><span class="pln">        mPairedDevicesArrayAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">device_name</span><span class="pun">);</span></li><li><a name="82"></a><span class="pln">        mNewDevicesArrayAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">device_name</span><span class="pun">);</span></li><li><a name="83"></a></li><li><a name="84"></a><span class="pln">        </span><span class="com">// Find and set up the ListView for paired devices</span></li><li><a name="85"></a><span class="pln">        </span><span class="typ">ListView</span><span class="pln"> pairedListView </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ListView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">paired_devices</span><span class="pun">);</span></li><li><a name="86"></a><span class="pln">        pairedListView</span><span class="pun">.</span><span class="pln">setAdapter</span><span class="pun">(</span><span class="pln">mPairedDevicesArrayAdapter</span><span class="pun">);</span></li><li><a name="87"></a><span class="pln">        pairedListView</span><span class="pun">.</span><span class="pln">setOnItemClickListener</span><span class="pun">(</span><span class="pln">mDeviceClickListener</span><span class="pun">);</span></li><li><a name="88"></a></li><li><a name="89"></a><span class="pln">        </span><span class="com">// Find and set up the ListView for newly discovered devices</span></li><li><a name="90"></a><span class="pln">        </span><span class="typ">ListView</span><span class="pln"> newDevicesListView </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ListView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">new_devices</span><span class="pun">);</span></li><li><a name="91"></a><span class="pln">        newDevicesListView</span><span class="pun">.</span><span class="pln">setAdapter</span><span class="pun">(</span><span class="pln">mNewDevicesArrayAdapter</span><span class="pun">);</span></li><li><a name="92"></a><span class="pln">        newDevicesListView</span><span class="pun">.</span><span class="pln">setOnItemClickListener</span><span class="pun">(</span><span class="pln">mDeviceClickListener</span><span class="pun">);</span></li><li><a name="93"></a></li><li><a name="94"></a><span class="pln">        </span><span class="com">// Register for broadcasts when a device is discovered</span></li><li><a name="95"></a><span class="pln">        </span><span class="typ">IntentFilter</span><span class="pln"> filter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">IntentFilter</span><span class="pun">(</span><span class="typ">BluetoothDevice</span><span class="pun">.</span><span class="pln">ACTION_FOUND</span><span class="pun">);</span></li><li><a name="96"></a><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">registerReceiver</span><span class="pun">(</span><span class="pln">mReceiver</span><span class="pun">,</span><span class="pln"> filter</span><span class="pun">);</span></li><li><a name="97"></a></li><li><a name="98"></a><span class="pln">        </span><span class="com">// Register for broadcasts when discovery has finished</span></li><li><a name="99"></a><span class="pln">        filter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">IntentFilter</span><span class="pun">(</span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">ACTION_DISCOVERY_FINISHED</span><span class="pun">);</span></li><li><a name="100"></a><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">registerReceiver</span><span class="pun">(</span><span class="pln">mReceiver</span><span class="pun">,</span><span class="pln"> filter</span><span class="pun">);</span></li><li><a name="101"></a></li><li><a name="102"></a><span class="pln">        </span><span class="com">// Get the local Bluetooth adapter</span></li><li><a name="103"></a><span class="pln">        mBtAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">getDefaultAdapter</span><span class="pun">();</span></li><li><a name="104"></a></li><li><a name="105"></a><span class="pln">        </span><span class="com">// Get a set of currently paired devices</span></li><li><a name="106"></a><span class="pln">        </span><span class="typ">Set</span><span class="pun">&lt;</span><span class="typ">BluetoothDevice</span><span class="pun">&gt;</span><span class="pln"> pairedDevices </span><span class="pun">=</span><span class="pln"> mBtAdapter</span><span class="pun">.</span><span class="pln">getBondedDevices</span><span class="pun">();</span></li><li><a name="107"></a></li><li><a name="108"></a><span class="pln">        </span><span class="com">// If there are paired devices, add each one to the ArrayAdapter</span></li><li><a name="109"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pairedDevices</span><span class="pun">.</span><span class="pln">size</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="110"></a><span class="pln">            findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">title_paired_devices</span><span class="pun">).</span><span class="pln">setVisibility</span><span class="pun">(</span><span class="typ">View</span><span class="pun">.</span><span class="pln">VISIBLE</span><span class="pun">);</span></li><li><a name="111"></a><span class="pln">            </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BluetoothDevice</span><span class="pln"> device </span><span class="pun">:</span><span class="pln"> pairedDevices</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="112"></a><span class="pln">                mPairedDevicesArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">device</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">&quot;\n&quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> device</span><span class="pun">.</span><span class="pln">getAddress</span><span class="pun">());</span></li><li><a name="113"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="114"></a><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="115"></a><span class="pln">            </span><span class="typ">String</span><span class="pln"> noDevices </span><span class="pun">=</span><span class="pln"> getResources</span><span class="pun">().</span><span class="pln">getText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">none_paired</span><span class="pun">).</span><span class="pln">toString</span><span class="pun">();</span></li><li><a name="116"></a><span class="pln">            mPairedDevicesArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">noDevices</span><span class="pun">);</span></li><li><a name="117"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="118"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="119"></a></li><li><a name="120"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="121"></a><span class="pln">    </span><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onDestroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="122"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onDestroy</span><span class="pun">();</span></li><li><a name="123"></a></li><li><a name="124"></a><span class="pln">        </span><span class="com">// Make sure we&#39;re not doing discovery anymore</span></li><li><a name="125"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mBtAdapter </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="126"></a><span class="pln">            mBtAdapter</span><span class="pun">.</span><span class="pln">cancelDiscovery</span><span class="pun">();</span></li><li><a name="127"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="128"></a></li><li><a name="129"></a><span class="pln">        </span><span class="com">// Unregister broadcast listeners</span></li><li><a name="130"></a><span class="pln">        </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">unregisterReceiver</span><span class="pun">(</span><span class="pln">mReceiver</span><span class="pun">);</span></li><li><a name="131"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="132"></a></li><li><a name="133"></a><span class="pln">    </span><span class="com">/**</span></li><li><a name="134"></a><span class="com">     * Start device discover with the BluetoothAdapter</span></li><li><a name="135"></a><span class="com">     */</span></li><li><a name="136"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> doDiscovery</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="137"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">d</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;doDiscovery()&quot;</span><span class="pun">);</span></li><li><a name="138"></a></li><li><a name="139"></a><span class="pln">        </span><span class="com">// Indicate scanning in the title</span></li><li><a name="140"></a><span class="pln">        setProgressBarIndeterminateVisibility</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span></li><li><a name="141"></a><span class="pln">        setTitle</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">scanning</span><span class="pun">);</span></li><li><a name="142"></a></li><li><a name="143"></a><span class="pln">        </span><span class="com">// Turn on sub-title for new devices</span></li><li><a name="144"></a><span class="pln">        findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">title_new_devices</span><span class="pun">).</span><span class="pln">setVisibility</span><span class="pun">(</span><span class="typ">View</span><span class="pun">.</span><span class="pln">VISIBLE</span><span class="pun">);</span></li><li><a name="145"></a></li><li><a name="146"></a><span class="pln">        </span><span class="com">// If we&#39;re already discovering, stop it</span></li><li><a name="147"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mBtAdapter</span><span class="pun">.</span><span class="pln">isDiscovering</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="148"></a><span class="pln">            mBtAdapter</span><span class="pun">.</span><span class="pln">cancelDiscovery</span><span class="pun">();</span></li><li><a name="149"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="150"></a></li><li><a name="151"></a><span class="pln">        </span><span class="com">// Request discover from BluetoothAdapter</span></li><li><a name="152"></a><span class="pln">        mBtAdapter</span><span class="pun">.</span><span class="pln">startDiscovery</span><span class="pun">();</span></li><li><a name="153"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="154"></a></li><li><a name="155"></a><span class="pln">    </span><span class="com">// The on-click listener for all devices in the ListViews</span></li><li><a name="156"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">OnItemClickListener</span><span class="pln"> mDeviceClickListener </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">OnItemClickListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="157"></a><span class="pln">        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onItemClick</span><span class="pun">(</span><span class="typ">AdapterView</span><span class="pun">&lt;?&gt;</span><span class="pln"> av</span><span class="pun">,</span><span class="pln"> </span><span class="typ">View</span><span class="pln"> v</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> arg2</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">long</span><span class="pln"> arg3</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="158"></a><span class="pln">            </span><span class="com">// Cancel discovery because it&#39;s costly and we&#39;re about to connect</span></li><li><a name="159"></a><span class="pln">            mBtAdapter</span><span class="pun">.</span><span class="pln">cancelDiscovery</span><span class="pun">();</span></li><li><a name="160"></a></li><li><a name="161"></a><span class="pln">            </span><span class="com">// Get the device MAC address, which is the last 17 chars in the View</span></li><li><a name="162"></a><span class="pln">            </span><span class="typ">String</span><span class="pln"> info </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="typ">TextView</span><span class="pun">)</span><span class="pln"> v</span><span class="pun">).</span><span class="pln">getText</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">();</span></li><li><a name="163"></a><span class="pln">            </span><span class="typ">String</span><span class="pln"> address </span><span class="pun">=</span><span class="pln"> info</span><span class="pun">.</span><span class="pln">substring</span><span class="pun">(</span><span class="pln">info</span><span class="pun">.</span><span class="pln">length</span><span class="pun">()</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="lit">17</span><span class="pun">);</span></li><li><a name="164"></a></li><li><a name="165"></a><span class="pln">            </span><span class="com">// Create the result Intent and include the MAC address</span></li><li><a name="166"></a><span class="pln">            </span><span class="typ">Intent</span><span class="pln"> intent </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">();</span></li><li><a name="167"></a><span class="pln">            intent</span><span class="pun">.</span><span class="pln">putExtra</span><span class="pun">(</span><span class="pln">EXTRA_DEVICE_ADDRESS</span><span class="pun">,</span><span class="pln"> address</span><span class="pun">);</span></li><li><a name="168"></a></li><li><a name="169"></a><span class="pln">            </span><span class="com">// Set result and finish this Activity</span></li><li><a name="170"></a><span class="pln">            setResult</span><span class="pun">(</span><span class="typ">Activity</span><span class="pun">.</span><span class="pln">RESULT_OK</span><span class="pun">,</span><span class="pln"> intent</span><span class="pun">);</span></li><li><a name="171"></a><span class="pln">            finish</span><span class="pun">();</span></li><li><a name="172"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="173"></a><span class="pln">    </span><span class="pun">};</span></li><li><a name="174"></a></li><li><a name="175"></a><span class="pln">    </span><span class="com">// The BroadcastReceiver that listens for discovered devices and</span></li><li><a name="176"></a><span class="pln">    </span><span class="com">// changes the title when discovery is finished</span></li><li><a name="177"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">BroadcastReceiver</span><span class="pln"> mReceiver </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BroadcastReceiver</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="178"></a><span class="pln">        </span><span class="lit">@Override</span></li><li><a name="179"></a><span class="pln">        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onReceive</span><span class="pun">(</span><span class="typ">Context</span><span class="pln"> context</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Intent</span><span class="pln"> intent</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="180"></a><span class="pln">            </span><span class="typ">String</span><span class="pln"> action </span><span class="pun">=</span><span class="pln"> intent</span><span class="pun">.</span><span class="pln">getAction</span><span class="pun">();</span></li><li><a name="181"></a></li><li><a name="182"></a><span class="pln">            </span><span class="com">// When discovery finds a device</span></li><li><a name="183"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BluetoothDevice</span><span class="pun">.</span><span class="pln">ACTION_FOUND</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="pln">action</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="184"></a><span class="pln">                </span><span class="com">// Get the BluetoothDevice object from the Intent</span></li><li><a name="185"></a><span class="pln">                </span><span class="typ">BluetoothDevice</span><span class="pln"> device </span><span class="pun">=</span><span class="pln"> intent</span><span class="pun">.</span><span class="pln">getParcelableExtra</span><span class="pun">(</span><span class="typ">BluetoothDevice</span><span class="pun">.</span><span class="pln">EXTRA_DEVICE</span><span class="pun">);</span></li><li><a name="186"></a><span class="pln">                </span><span class="com">// If it&#39;s already paired, skip it, because it&#39;s been listed already</span></li><li><a name="187"></a><span class="pln">                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">device</span><span class="pun">.</span><span class="pln">getBondState</span><span class="pun">()</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="typ">BluetoothDevice</span><span class="pun">.</span><span class="pln">BOND_BONDED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="188"></a><span class="pln">                    mNewDevicesArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">device</span><span class="pun">.</span><span class="pln">getName</span><span class="pun">()</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">&quot;\n&quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> device</span><span class="pun">.</span><span class="pln">getAddress</span><span class="pun">());</span></li><li><a name="189"></a><span class="pln">                </span><span class="pun">}</span></li><li><a name="190"></a><span class="pln">            </span><span class="com">// When discovery is finished, change the Activity title</span></li><li><a name="191"></a><span class="pln">            </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">ACTION_DISCOVERY_FINISHED</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="pln">action</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="192"></a><span class="pln">                setProgressBarIndeterminateVisibility</span><span class="pun">(</span><span class="kwd">false</span><span class="pun">);</span></li><li><a name="193"></a><span class="pln">                setTitle</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">select_device</span><span class="pun">);</span></li><li><a name="194"></a><span class="pln">                </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mNewDevicesArrayAdapter</span><span class="pun">.</span><span class="pln">getCount</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="195"></a><span class="pln">                    </span><span class="typ">String</span><span class="pln"> noDevices </span><span class="pun">=</span><span class="pln"> getResources</span><span class="pun">().</span><span class="pln">getText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">none_found</span><span class="pun">).</span><span class="pln">toString</span><span class="pun">();</span></li><li><a name="196"></a><span class="pln">                    mNewDevicesArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">noDevices</span><span class="pun">);</span></li><li><a name="197"></a><span class="pln">                </span><span class="pun">}</span></li><li><a name="198"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="199"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="200"></a><span class="pln">    </span><span class="pun">};</span></li><li><a name="201"></a></li><li><a name="202"></a><span class="pun">}</span></li></ol><div class="footer">Powered by <a href="https://code.google.com/p/gitiles/">Gitiles</a></div></body></html>