<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>samples/BluetoothChat/src/com/example/android/BluetoothChat/BluetoothChat.java - platform/development - Git at Google</title><link rel="stylesheet" type="text/css" href="//www.google.com/css/go.css" /><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.pZ5FqzM6cPxAflH0va2Ucw.cache.css" /><link rel="stylesheet" type="text/css" href="/+static/gitiles.1WJVkAfC8yZIr9tnmjVI0Q.cache.css" /></head><body><h1><img src="//www.google.com/images/logo_sm.gif" alt="Google" />Git</h1><div class="menu"> <a href="https://www.google.com/a/SelectSession?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/platform/development/%2B/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/BluetoothChat.java">Sign in</a> </div><div class="breadcrumbs"><a href="/?format=HTML">android</a> / <a href="/platform/development/">platform/development</a> / <a href="/platform/development/+/eclair-passion-release">eclair-passion-release</a> / <a href="/platform/development/+/eclair-passion-release/">.</a> / <a href="/platform/development/+/eclair-passion-release/samples">samples</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat">BluetoothChat</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src?autodive=0">src</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com?autodive=0">com</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example?autodive=0">example</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android?autodive=0">android</a> / <a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat">BluetoothChat</a> / BluetoothChat.java</div><div class="sha1">blob: d05bbd6118938fcef97dda56d02be9ea0b2f5bf2 [<a href="/platform/development/+/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/BluetoothChat.java">file</a>] [<a href="/platform/development/+log/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/BluetoothChat.java">log</a>] [<a href="/platform/development/+blame/eclair-passion-release/samples/BluetoothChat/src/com/example/android/BluetoothChat/BluetoothChat.java">blame</a>]</div><ol class="prettyprint"><li><a name="1"></a><span class="com">/*</span></li><li><a name="2"></a><span class="com"> * Copyright (C) 2009 The Android Open Source Project</span></li><li><a name="3"></a><span class="com"> *</span></li><li><a name="4"></a><span class="com"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></li><li><a name="5"></a><span class="com"> * you may not use this file except in compliance with the License.</span></li><li><a name="6"></a><span class="com"> * You may obtain a copy of the License at</span></li><li><a name="7"></a><span class="com"> *</span></li><li><a name="8"></a><span class="com"> *      http://www.apache.org/licenses/LICENSE-2.0</span></li><li><a name="9"></a><span class="com"> *</span></li><li><a name="10"></a><span class="com"> * Unless required by applicable law or agreed to in writing, software</span></li><li><a name="11"></a><span class="com"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></li><li><a name="12"></a><span class="com"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></li><li><a name="13"></a><span class="com"> * See the License for the specific language governing permissions and</span></li><li><a name="14"></a><span class="com"> * limitations under the License.</span></li><li><a name="15"></a><span class="com"> */</span></li><li><a name="16"></a></li><li><a name="17"></a><span class="kwd">package</span><span class="pln"> com</span><span class="pun">.</span><span class="pln">example</span><span class="pun">.</span><span class="pln">android</span><span class="pun">.</span><span class="typ">BluetoothChat</span><span class="pun">;</span></li><li><a name="18"></a></li><li><a name="19"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">app</span><span class="pun">.</span><span class="typ">Activity</span><span class="pun">;</span></li><li><a name="20"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">bluetooth</span><span class="pun">.</span><span class="typ">BluetoothAdapter</span><span class="pun">;</span></li><li><a name="21"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">bluetooth</span><span class="pun">.</span><span class="typ">BluetoothDevice</span><span class="pun">;</span></li><li><a name="22"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">content</span><span class="pun">.</span><span class="typ">Intent</span><span class="pun">;</span></li><li><a name="23"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Bundle</span><span class="pun">;</span></li><li><a name="24"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Handler</span><span class="pun">;</span></li><li><a name="25"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">os</span><span class="pun">.</span><span class="typ">Message</span><span class="pun">;</span></li><li><a name="26"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">util</span><span class="pun">.</span><span class="typ">Log</span><span class="pun">;</span></li><li><a name="27"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">KeyEvent</span><span class="pun">;</span></li><li><a name="28"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">Menu</span><span class="pun">;</span></li><li><a name="29"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">MenuInflater</span><span class="pun">;</span></li><li><a name="30"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">MenuItem</span><span class="pun">;</span></li><li><a name="31"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">View</span><span class="pun">;</span></li><li><a name="32"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">Window</span><span class="pun">;</span></li><li><a name="33"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="typ">View</span><span class="pun">.</span><span class="typ">OnClickListener</span><span class="pun">;</span></li><li><a name="34"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="pln">inputmethod</span><span class="pun">.</span><span class="typ">EditorInfo</span><span class="pun">;</span></li><li><a name="35"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">ArrayAdapter</span><span class="pun">;</span></li><li><a name="36"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">Button</span><span class="pun">;</span></li><li><a name="37"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">EditText</span><span class="pun">;</span></li><li><a name="38"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">ListView</span><span class="pun">;</span></li><li><a name="39"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">TextView</span><span class="pun">;</span></li><li><a name="40"></a><span class="kwd">import</span><span class="pln"> android</span><span class="pun">.</span><span class="pln">widget</span><span class="pun">.</span><span class="typ">Toast</span><span class="pun">;</span></li><li><a name="41"></a></li><li><a name="42"></a><span class="com">/**</span></li><li><a name="43"></a><span class="com"> * This is the main Activity that displays the current chat session.</span></li><li><a name="44"></a><span class="com"> */</span></li><li><a name="45"></a><span class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> </span><span class="typ">BluetoothChat</span><span class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span class="typ">Activity</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="46"></a><span class="pln">    </span><span class="com">// Debugging</span></li><li><a name="47"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> TAG </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;BluetoothChat&quot;</span><span class="pun">;</span></li><li><a name="48"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> D </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="49"></a></li><li><a name="50"></a><span class="pln">    </span><span class="com">// Message types sent from the BluetoothChatService Handler</span></li><li><a name="51"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> MESSAGE_STATE_CHANGE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="52"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> MESSAGE_READ </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span></li><li><a name="53"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> MESSAGE_WRITE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span></li><li><a name="54"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> MESSAGE_DEVICE_NAME </span><span class="pun">=</span><span class="pln"> </span><span class="lit">4</span><span class="pun">;</span></li><li><a name="55"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> MESSAGE_TOAST </span><span class="pun">=</span><span class="pln"> </span><span class="lit">5</span><span class="pun">;</span></li><li><a name="56"></a></li><li><a name="57"></a><span class="pln">    </span><span class="com">// Key names received from the BluetoothChatService Handler</span></li><li><a name="58"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> DEVICE_NAME </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;device_name&quot;</span><span class="pun">;</span></li><li><a name="59"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> TOAST </span><span class="pun">=</span><span class="pln"> </span><span class="str">&quot;toast&quot;</span><span class="pun">;</span></li><li><a name="60"></a></li><li><a name="61"></a><span class="pln">    </span><span class="com">// Intent request codes</span></li><li><a name="62"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> REQUEST_CONNECT_DEVICE </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="63"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> REQUEST_ENABLE_BT </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span></li><li><a name="64"></a></li><li><a name="65"></a><span class="pln">    </span><span class="com">// Layout Views</span></li><li><a name="66"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">TextView</span><span class="pln"> mTitle</span><span class="pun">;</span></li><li><a name="67"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">ListView</span><span class="pln"> mConversationView</span><span class="pun">;</span></li><li><a name="68"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">EditText</span><span class="pln"> mOutEditText</span><span class="pun">;</span></li><li><a name="69"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">Button</span><span class="pln"> mSendButton</span><span class="pun">;</span></li><li><a name="70"></a></li><li><a name="71"></a><span class="pln">    </span><span class="com">// Name of the connected device</span></li><li><a name="72"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">String</span><span class="pln"> mConnectedDeviceName </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></li><li><a name="73"></a><span class="pln">    </span><span class="com">// Array adapter for the conversation thread</span></li><li><a name="74"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;</span><span class="pln"> mConversationArrayAdapter</span><span class="pun">;</span></li><li><a name="75"></a><span class="pln">    </span><span class="com">// String buffer for outgoing messages</span></li><li><a name="76"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">StringBuffer</span><span class="pln"> mOutStringBuffer</span><span class="pun">;</span></li><li><a name="77"></a><span class="pln">    </span><span class="com">// Local Bluetooth adapter</span></li><li><a name="78"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">BluetoothAdapter</span><span class="pln"> mBluetoothAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></li><li><a name="79"></a><span class="pln">    </span><span class="com">// Member object for the chat services</span></li><li><a name="80"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pln"> mChatService </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></li><li><a name="81"></a></li><li><a name="82"></a></li><li><a name="83"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="84"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onCreate</span><span class="pun">(</span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="85"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onCreate</span><span class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span></li><li><a name="86"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;+++ ON CREATE +++&quot;</span><span class="pun">);</span></li><li><a name="87"></a></li><li><a name="88"></a><span class="pln">        </span><span class="com">// Set up the window layout</span></li><li><a name="89"></a><span class="pln">        requestWindowFeature</span><span class="pun">(</span><span class="typ">Window</span><span class="pun">.</span><span class="pln">FEATURE_CUSTOM_TITLE</span><span class="pun">);</span></li><li><a name="90"></a><span class="pln">        setContentView</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">main</span><span class="pun">);</span></li><li><a name="91"></a><span class="pln">        getWindow</span><span class="pun">().</span><span class="pln">setFeatureInt</span><span class="pun">(</span><span class="typ">Window</span><span class="pun">.</span><span class="pln">FEATURE_CUSTOM_TITLE</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">custom_title</span><span class="pun">);</span></li><li><a name="92"></a></li><li><a name="93"></a><span class="pln">        </span><span class="com">// Set up the custom title</span></li><li><a name="94"></a><span class="pln">        mTitle </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">TextView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">title_left_text</span><span class="pun">);</span></li><li><a name="95"></a><span class="pln">        mTitle</span><span class="pun">.</span><span class="pln">setText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">app_name</span><span class="pun">);</span></li><li><a name="96"></a><span class="pln">        mTitle </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">TextView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">title_right_text</span><span class="pun">);</span></li><li><a name="97"></a></li><li><a name="98"></a><span class="pln">        </span><span class="com">// Get local Bluetooth adapter</span></li><li><a name="99"></a><span class="pln">        mBluetoothAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">getDefaultAdapter</span><span class="pun">();</span></li><li><a name="100"></a></li><li><a name="101"></a><span class="pln">        </span><span class="com">// If the adapter is null, then Bluetooth is not supported</span></li><li><a name="102"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mBluetoothAdapter </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="103"></a><span class="pln">            </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;Bluetooth is not available&quot;</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_LONG</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></li><li><a name="104"></a><span class="pln">            finish</span><span class="pun">();</span></li><li><a name="105"></a><span class="pln">            </span><span class="kwd">return</span><span class="pun">;</span></li><li><a name="106"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="107"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="108"></a></li><li><a name="109"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="110"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onStart</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="111"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onStart</span><span class="pun">();</span></li><li><a name="112"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;++ ON START ++&quot;</span><span class="pun">);</span></li><li><a name="113"></a></li><li><a name="114"></a><span class="pln">        </span><span class="com">// If BT is not on, request that it be enabled.</span></li><li><a name="115"></a><span class="pln">        </span><span class="com">// setupChat() will then be called during onActivityResult</span></li><li><a name="116"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">mBluetoothAdapter</span><span class="pun">.</span><span class="pln">isEnabled</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="117"></a><span class="pln">            </span><span class="typ">Intent</span><span class="pln"> enableIntent </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">(</span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">ACTION_REQUEST_ENABLE</span><span class="pun">);</span></li><li><a name="118"></a><span class="pln">            startActivityForResult</span><span class="pun">(</span><span class="pln">enableIntent</span><span class="pun">,</span><span class="pln"> REQUEST_ENABLE_BT</span><span class="pun">);</span></li><li><a name="119"></a><span class="pln">        </span><span class="com">// Otherwise, setup the chat session</span></li><li><a name="120"></a><span class="pln">        </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="121"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mChatService </span><span class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> setupChat</span><span class="pun">();</span></li><li><a name="122"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="123"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="124"></a></li><li><a name="125"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="126"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onResume</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="127"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onResume</span><span class="pun">();</span></li><li><a name="128"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;+ ON RESUME +&quot;</span><span class="pun">);</span></li><li><a name="129"></a></li><li><a name="130"></a><span class="pln">        </span><span class="com">// Performing this check in onResume() covers the case in which BT was</span></li><li><a name="131"></a><span class="pln">        </span><span class="com">// not enabled during onStart(), so we were paused to enable it...</span></li><li><a name="132"></a><span class="pln">        </span><span class="com">// onResume() will be called when ACTION_REQUEST_ENABLE activity returns.</span></li><li><a name="133"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mChatService </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="134"></a><span class="pln">            </span><span class="com">// Only if the state is STATE_NONE, do we know that we haven&#39;t started already</span></li><li><a name="135"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mChatService</span><span class="pun">.</span><span class="pln">getState</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_NONE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="136"></a><span class="pln">              </span><span class="com">// Start the Bluetooth chat services</span></li><li><a name="137"></a><span class="pln">              mChatService</span><span class="pun">.</span><span class="pln">start</span><span class="pun">();</span></li><li><a name="138"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="139"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="140"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="141"></a></li><li><a name="142"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> setupChat</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="143"></a><span class="pln">        </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">d</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;setupChat()&quot;</span><span class="pun">);</span></li><li><a name="144"></a></li><li><a name="145"></a><span class="pln">        </span><span class="com">// Initialize the array adapter for the conversation thread</span></li><li><a name="146"></a><span class="pln">        mConversationArrayAdapter </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">ArrayAdapter</span><span class="pun">&lt;</span><span class="typ">String</span><span class="pun">&gt;(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span class="pln">message</span><span class="pun">);</span></li><li><a name="147"></a><span class="pln">        mConversationView </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">ListView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">in</span><span class="pun">);</span></li><li><a name="148"></a><span class="pln">        mConversationView</span><span class="pun">.</span><span class="pln">setAdapter</span><span class="pun">(</span><span class="pln">mConversationArrayAdapter</span><span class="pun">);</span></li><li><a name="149"></a></li><li><a name="150"></a><span class="pln">        </span><span class="com">// Initialize the compose field with a listener for the return key</span></li><li><a name="151"></a><span class="pln">        mOutEditText </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">EditText</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">edit_text_out</span><span class="pun">);</span></li><li><a name="152"></a><span class="pln">        mOutEditText</span><span class="pun">.</span><span class="pln">setOnEditorActionListener</span><span class="pun">(</span><span class="pln">mWriteListener</span><span class="pun">);</span></li><li><a name="153"></a></li><li><a name="154"></a><span class="pln">        </span><span class="com">// Initialize the send button with a listener that for click events</span></li><li><a name="155"></a><span class="pln">        mSendButton </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Button</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">button_send</span><span class="pun">);</span></li><li><a name="156"></a><span class="pln">        mSendButton</span><span class="pun">.</span><span class="pln">setOnClickListener</span><span class="pun">(</span><span class="kwd">new</span><span class="pln"> </span><span class="typ">OnClickListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="157"></a><span class="pln">            </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onClick</span><span class="pun">(</span><span class="typ">View</span><span class="pln"> v</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="158"></a><span class="pln">                </span><span class="com">// Send a message using content of the edit text widget</span></li><li><a name="159"></a><span class="pln">                </span><span class="typ">TextView</span><span class="pln"> view </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">TextView</span><span class="pun">)</span><span class="pln"> findViewById</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">edit_text_out</span><span class="pun">);</span></li><li><a name="160"></a><span class="pln">                </span><span class="typ">String</span><span class="pln"> message </span><span class="pun">=</span><span class="pln"> view</span><span class="pun">.</span><span class="pln">getText</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">();</span></li><li><a name="161"></a><span class="pln">                sendMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">);</span></li><li><a name="162"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="163"></a><span class="pln">        </span><span class="pun">});</span></li><li><a name="164"></a></li><li><a name="165"></a><span class="pln">        </span><span class="com">// Initialize the BluetoothChatService to perform bluetooth connections</span></li><li><a name="166"></a><span class="pln">        mChatService </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> mHandler</span><span class="pun">);</span></li><li><a name="167"></a></li><li><a name="168"></a><span class="pln">        </span><span class="com">// Initialize the buffer for outgoing messages</span></li><li><a name="169"></a><span class="pln">        mOutStringBuffer </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">StringBuffer</span><span class="pun">(</span><span class="str">&quot;&quot;</span><span class="pun">);</span></li><li><a name="170"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="171"></a></li><li><a name="172"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="173"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">synchronized</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onPause</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="174"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onPause</span><span class="pun">();</span></li><li><a name="175"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;- ON PAUSE -&quot;</span><span class="pun">);</span></li><li><a name="176"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="177"></a></li><li><a name="178"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="179"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onStop</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="180"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onStop</span><span class="pun">();</span></li><li><a name="181"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;-- ON STOP --&quot;</span><span class="pun">);</span></li><li><a name="182"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="183"></a></li><li><a name="184"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="185"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onDestroy</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="186"></a><span class="pln">        </span><span class="kwd">super</span><span class="pun">.</span><span class="pln">onDestroy</span><span class="pun">();</span></li><li><a name="187"></a><span class="pln">        </span><span class="com">// Stop the Bluetooth chat services</span></li><li><a name="188"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mChatService </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span class="pln"> mChatService</span><span class="pun">.</span><span class="pln">stop</span><span class="pun">();</span></li><li><a name="189"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">e</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;--- ON DESTROY ---&quot;</span><span class="pun">);</span></li><li><a name="190"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="191"></a></li><li><a name="192"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> ensureDiscoverable</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="193"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">d</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;ensure discoverable&quot;</span><span class="pun">);</span></li><li><a name="194"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mBluetoothAdapter</span><span class="pun">.</span><span class="pln">getScanMode</span><span class="pun">()</span><span class="pln"> </span><span class="pun">!=</span></li><li><a name="195"></a><span class="pln">            </span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">SCAN_MODE_CONNECTABLE_DISCOVERABLE</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="196"></a><span class="pln">            </span><span class="typ">Intent</span><span class="pln"> discoverableIntent </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">(</span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">ACTION_REQUEST_DISCOVERABLE</span><span class="pun">);</span></li><li><a name="197"></a><span class="pln">            discoverableIntent</span><span class="pun">.</span><span class="pln">putExtra</span><span class="pun">(</span><span class="typ">BluetoothAdapter</span><span class="pun">.</span><span class="pln">EXTRA_DISCOVERABLE_DURATION</span><span class="pun">,</span><span class="pln"> </span><span class="lit">300</span><span class="pun">);</span></li><li><a name="198"></a><span class="pln">            startActivity</span><span class="pun">(</span><span class="pln">discoverableIntent</span><span class="pun">);</span></li><li><a name="199"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="200"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="201"></a></li><li><a name="202"></a><span class="pln">    </span><span class="com">/**</span></li><li><a name="203"></a><span class="com">     * Sends a message.</span></li><li><a name="204"></a><span class="com">     * @param message  A string of text to send.</span></li><li><a name="205"></a><span class="com">     */</span></li><li><a name="206"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> sendMessage</span><span class="pun">(</span><span class="typ">String</span><span class="pln"> message</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="207"></a><span class="pln">        </span><span class="com">// Check that we&#39;re actually connected before trying anything</span></li><li><a name="208"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mChatService</span><span class="pun">.</span><span class="pln">getState</span><span class="pun">()</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_CONNECTED</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="209"></a><span class="pln">            </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">not_connected</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_SHORT</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></li><li><a name="210"></a><span class="pln">            </span><span class="kwd">return</span><span class="pun">;</span></li><li><a name="211"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="212"></a></li><li><a name="213"></a><span class="pln">        </span><span class="com">// Check that there&#39;s actually something to send</span></li><li><a name="214"></a><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">message</span><span class="pun">.</span><span class="pln">length</span><span class="pun">()</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="215"></a><span class="pln">            </span><span class="com">// Get the message bytes and tell the BluetoothChatService to write</span></li><li><a name="216"></a><span class="pln">            </span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> send </span><span class="pun">=</span><span class="pln"> message</span><span class="pun">.</span><span class="pln">getBytes</span><span class="pun">();</span></li><li><a name="217"></a><span class="pln">            mChatService</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">send</span><span class="pun">);</span></li><li><a name="218"></a></li><li><a name="219"></a><span class="pln">            </span><span class="com">// Reset out string buffer to zero and clear the edit text field</span></li><li><a name="220"></a><span class="pln">            mOutStringBuffer</span><span class="pun">.</span><span class="pln">setLength</span><span class="pun">(</span><span class="lit">0</span><span class="pun">);</span></li><li><a name="221"></a><span class="pln">            mOutEditText</span><span class="pun">.</span><span class="pln">setText</span><span class="pun">(</span><span class="pln">mOutStringBuffer</span><span class="pun">);</span></li><li><a name="222"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="223"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="224"></a></li><li><a name="225"></a><span class="pln">    </span><span class="com">// The action listener for the EditText widget, to listen for the return key</span></li><li><a name="226"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="typ">TextView</span><span class="pun">.</span><span class="typ">OnEditorActionListener</span><span class="pln"> mWriteListener </span><span class="pun">=</span></li><li><a name="227"></a><span class="pln">        </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">TextView</span><span class="pun">.</span><span class="typ">OnEditorActionListener</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="228"></a><span class="pln">        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> onEditorAction</span><span class="pun">(</span><span class="typ">TextView</span><span class="pln"> view</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> actionId</span><span class="pun">,</span><span class="pln"> </span><span class="typ">KeyEvent</span><span class="pln"> event</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="229"></a><span class="pln">            </span><span class="com">// If the action is a key-up event on the return key, send the message</span></li><li><a name="230"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">actionId </span><span class="pun">==</span><span class="pln"> </span><span class="typ">EditorInfo</span><span class="pun">.</span><span class="pln">IME_NULL </span><span class="pun">&amp;&amp;</span><span class="pln"> event</span><span class="pun">.</span><span class="pln">getAction</span><span class="pun">()</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="typ">KeyEvent</span><span class="pun">.</span><span class="pln">ACTION_UP</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="231"></a><span class="pln">                </span><span class="typ">String</span><span class="pln"> message </span><span class="pun">=</span><span class="pln"> view</span><span class="pun">.</span><span class="pln">getText</span><span class="pun">().</span><span class="pln">toString</span><span class="pun">();</span></li><li><a name="232"></a><span class="pln">                sendMessage</span><span class="pun">(</span><span class="pln">message</span><span class="pun">);</span></li><li><a name="233"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="234"></a><span class="pln">            </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">i</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;END onEditorAction&quot;</span><span class="pun">);</span></li><li><a name="235"></a><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="236"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="237"></a><span class="pln">    </span><span class="pun">};</span></li><li><a name="238"></a></li><li><a name="239"></a><span class="pln">    </span><span class="com">// The Handler that gets information back from the BluetoothChatService</span></li><li><a name="240"></a><span class="pln">    </span><span class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span class="typ">Handler</span><span class="pln"> mHandler </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Handler</span><span class="pun">()</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="241"></a><span class="pln">        </span><span class="lit">@Override</span></li><li><a name="242"></a><span class="pln">        </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> handleMessage</span><span class="pun">(</span><span class="typ">Message</span><span class="pln"> msg</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="243"></a><span class="pln">            </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">what</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="244"></a><span class="pln">            </span><span class="kwd">case</span><span class="pln"> MESSAGE_STATE_CHANGE</span><span class="pun">:</span></li><li><a name="245"></a><span class="pln">                </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">i</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;MESSAGE_STATE_CHANGE: &quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">arg1</span><span class="pun">);</span></li><li><a name="246"></a><span class="pln">                </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">msg</span><span class="pun">.</span><span class="pln">arg1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="247"></a><span class="pln">                </span><span class="kwd">case</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_CONNECTED</span><span class="pun">:</span></li><li><a name="248"></a><span class="pln">                    mTitle</span><span class="pun">.</span><span class="pln">setText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">title_connected_to</span><span class="pun">);</span></li><li><a name="249"></a><span class="pln">                    mTitle</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">mConnectedDeviceName</span><span class="pun">);</span></li><li><a name="250"></a><span class="pln">                    mConversationArrayAdapter</span><span class="pun">.</span><span class="pln">clear</span><span class="pun">();</span></li><li><a name="251"></a><span class="pln">                    </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="252"></a><span class="pln">                </span><span class="kwd">case</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_CONNECTING</span><span class="pun">:</span></li><li><a name="253"></a><span class="pln">                    mTitle</span><span class="pun">.</span><span class="pln">setText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">title_connecting</span><span class="pun">);</span></li><li><a name="254"></a><span class="pln">                    </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="255"></a><span class="pln">                </span><span class="kwd">case</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_LISTEN</span><span class="pun">:</span></li><li><a name="256"></a><span class="pln">                </span><span class="kwd">case</span><span class="pln"> </span><span class="typ">BluetoothChatService</span><span class="pun">.</span><span class="pln">STATE_NONE</span><span class="pun">:</span></li><li><a name="257"></a><span class="pln">                    mTitle</span><span class="pun">.</span><span class="pln">setText</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">title_not_connected</span><span class="pun">);</span></li><li><a name="258"></a><span class="pln">                    </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="259"></a><span class="pln">                </span><span class="pun">}</span></li><li><a name="260"></a><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="261"></a><span class="pln">            </span><span class="kwd">case</span><span class="pln"> MESSAGE_WRITE</span><span class="pun">:</span></li><li><a name="262"></a><span class="pln">                </span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> writeBuf </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">[])</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">obj</span><span class="pun">;</span></li><li><a name="263"></a><span class="pln">                </span><span class="com">// construct a string from the buffer</span></li><li><a name="264"></a><span class="pln">                </span><span class="typ">String</span><span class="pln"> writeMessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">String</span><span class="pun">(</span><span class="pln">writeBuf</span><span class="pun">);</span></li><li><a name="265"></a><span class="pln">                mConversationArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="str">&quot;Me:  &quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> writeMessage</span><span class="pun">);</span></li><li><a name="266"></a><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="267"></a><span class="pln">            </span><span class="kwd">case</span><span class="pln"> MESSAGE_READ</span><span class="pun">:</span></li><li><a name="268"></a><span class="pln">                </span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> readBuf </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">byte</span><span class="pun">[])</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">obj</span><span class="pun">;</span></li><li><a name="269"></a><span class="pln">                </span><span class="com">// construct a string from the valid bytes in the buffer</span></li><li><a name="270"></a><span class="pln">                </span><span class="typ">String</span><span class="pln"> readMessage </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">String</span><span class="pun">(</span><span class="pln">readBuf</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">arg1</span><span class="pun">);</span></li><li><a name="271"></a><span class="pln">                mConversationArrayAdapter</span><span class="pun">.</span><span class="pln">add</span><span class="pun">(</span><span class="pln">mConnectedDeviceName</span><span class="pun">+</span><span class="str">&quot;:  &quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> readMessage</span><span class="pun">);</span></li><li><a name="272"></a><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="273"></a><span class="pln">            </span><span class="kwd">case</span><span class="pln"> MESSAGE_DEVICE_NAME</span><span class="pun">:</span></li><li><a name="274"></a><span class="pln">                </span><span class="com">// save the connected device&#39;s name</span></li><li><a name="275"></a><span class="pln">                mConnectedDeviceName </span><span class="pun">=</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">getData</span><span class="pun">().</span><span class="pln">getString</span><span class="pun">(</span><span class="pln">DEVICE_NAME</span><span class="pun">);</span></li><li><a name="276"></a><span class="pln">                </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="pln">getApplicationContext</span><span class="pun">(),</span><span class="pln"> </span><span class="str">&quot;Connected to &quot;</span></li><li><a name="277"></a><span class="pln">                               </span><span class="pun">+</span><span class="pln"> mConnectedDeviceName</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_SHORT</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></li><li><a name="278"></a><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="279"></a><span class="pln">            </span><span class="kwd">case</span><span class="pln"> MESSAGE_TOAST</span><span class="pun">:</span></li><li><a name="280"></a><span class="pln">                </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="pln">getApplicationContext</span><span class="pun">(),</span><span class="pln"> msg</span><span class="pun">.</span><span class="pln">getData</span><span class="pun">().</span><span class="pln">getString</span><span class="pun">(</span><span class="pln">TOAST</span><span class="pun">),</span></li><li><a name="281"></a><span class="pln">                               </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_SHORT</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></li><li><a name="282"></a><span class="pln">                </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="283"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="284"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="285"></a><span class="pln">    </span><span class="pun">};</span></li><li><a name="286"></a></li><li><a name="287"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> onActivityResult</span><span class="pun">(</span><span class="kwd">int</span><span class="pln"> requestCode</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">int</span><span class="pln"> resultCode</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Intent</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="288"></a><span class="pln">        </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">D</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">d</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;onActivityResult &quot;</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> resultCode</span><span class="pun">);</span></li><li><a name="289"></a><span class="pln">        </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">requestCode</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="290"></a><span class="pln">        </span><span class="kwd">case</span><span class="pln"> REQUEST_CONNECT_DEVICE</span><span class="pun">:</span></li><li><a name="291"></a><span class="pln">            </span><span class="com">// When DeviceListActivity returns with a device to connect</span></li><li><a name="292"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">resultCode </span><span class="pun">==</span><span class="pln"> </span><span class="typ">Activity</span><span class="pun">.</span><span class="pln">RESULT_OK</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="293"></a><span class="pln">                </span><span class="com">// Get the device MAC address</span></li><li><a name="294"></a><span class="pln">                </span><span class="typ">String</span><span class="pln"> address </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">getExtras</span><span class="pun">()</span></li><li><a name="295"></a><span class="pln">                                     </span><span class="pun">.</span><span class="pln">getString</span><span class="pun">(</span><span class="typ">DeviceListActivity</span><span class="pun">.</span><span class="pln">EXTRA_DEVICE_ADDRESS</span><span class="pun">);</span></li><li><a name="296"></a><span class="pln">                </span><span class="com">// Get the BLuetoothDevice object</span></li><li><a name="297"></a><span class="pln">                </span><span class="typ">BluetoothDevice</span><span class="pln"> device </span><span class="pun">=</span><span class="pln"> mBluetoothAdapter</span><span class="pun">.</span><span class="pln">getRemoteDevice</span><span class="pun">(</span><span class="pln">address</span><span class="pun">);</span></li><li><a name="298"></a><span class="pln">                </span><span class="com">// Attempt to connect to the device</span></li><li><a name="299"></a><span class="pln">                mChatService</span><span class="pun">.</span><span class="pln">connect</span><span class="pun">(</span><span class="pln">device</span><span class="pun">);</span></li><li><a name="300"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="301"></a><span class="pln">            </span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="302"></a><span class="pln">        </span><span class="kwd">case</span><span class="pln"> REQUEST_ENABLE_BT</span><span class="pun">:</span></li><li><a name="303"></a><span class="pln">            </span><span class="com">// When the request to enable Bluetooth returns</span></li><li><a name="304"></a><span class="pln">            </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">resultCode </span><span class="pun">==</span><span class="pln"> </span><span class="typ">Activity</span><span class="pun">.</span><span class="pln">RESULT_OK</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="305"></a><span class="pln">                </span><span class="com">// Bluetooth is now enabled, so set up a chat session</span></li><li><a name="306"></a><span class="pln">                setupChat</span><span class="pun">();</span></li><li><a name="307"></a><span class="pln">            </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="308"></a><span class="pln">                </span><span class="com">// User did not enable Bluetooth or an error occured</span></li><li><a name="309"></a><span class="pln">                </span><span class="typ">Log</span><span class="pun">.</span><span class="pln">d</span><span class="pun">(</span><span class="pln">TAG</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;BT not enabled&quot;</span><span class="pun">);</span></li><li><a name="310"></a><span class="pln">                </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">makeText</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">string</span><span class="pun">.</span><span class="pln">bt_not_enabled_leaving</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Toast</span><span class="pun">.</span><span class="pln">LENGTH_SHORT</span><span class="pun">).</span><span class="pln">show</span><span class="pun">();</span></li><li><a name="311"></a><span class="pln">                finish</span><span class="pun">();</span></li><li><a name="312"></a><span class="pln">            </span><span class="pun">}</span></li><li><a name="313"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="314"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="315"></a></li><li><a name="316"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="317"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> onCreateOptionsMenu</span><span class="pun">(</span><span class="typ">Menu</span><span class="pln"> menu</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="318"></a><span class="pln">        </span><span class="typ">MenuInflater</span><span class="pln"> inflater </span><span class="pun">=</span><span class="pln"> getMenuInflater</span><span class="pun">();</span></li><li><a name="319"></a><span class="pln">        inflater</span><span class="pun">.</span><span class="pln">inflate</span><span class="pun">(</span><span class="pln">R</span><span class="pun">.</span><span class="pln">menu</span><span class="pun">.</span><span class="pln">option_menu</span><span class="pun">,</span><span class="pln"> menu</span><span class="pun">);</span></li><li><a name="320"></a><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="321"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="322"></a></li><li><a name="323"></a><span class="pln">    </span><span class="lit">@Override</span></li><li><a name="324"></a><span class="pln">    </span><span class="kwd">public</span><span class="pln"> </span><span class="kwd">boolean</span><span class="pln"> onOptionsItemSelected</span><span class="pun">(</span><span class="typ">MenuItem</span><span class="pln"> item</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="325"></a><span class="pln">        </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">item</span><span class="pun">.</span><span class="pln">getItemId</span><span class="pun">())</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="326"></a><span class="pln">        </span><span class="kwd">case</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">scan</span><span class="pun">:</span></li><li><a name="327"></a><span class="pln">            </span><span class="com">// Launch the DeviceListActivity to see devices and do scan</span></li><li><a name="328"></a><span class="pln">            </span><span class="typ">Intent</span><span class="pln"> serverIntent </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Intent</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">,</span><span class="pln"> </span><span class="typ">DeviceListActivity</span><span class="pun">.</span><span class="kwd">class</span><span class="pun">);</span></li><li><a name="329"></a><span class="pln">            startActivityForResult</span><span class="pun">(</span><span class="pln">serverIntent</span><span class="pun">,</span><span class="pln"> REQUEST_CONNECT_DEVICE</span><span class="pun">);</span></li><li><a name="330"></a><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="331"></a><span class="pln">        </span><span class="kwd">case</span><span class="pln"> R</span><span class="pun">.</span><span class="pln">id</span><span class="pun">.</span><span class="pln">discoverable</span><span class="pun">:</span></li><li><a name="332"></a><span class="pln">            </span><span class="com">// Ensure this device is discoverable by others</span></li><li><a name="333"></a><span class="pln">            ensureDiscoverable</span><span class="pun">();</span></li><li><a name="334"></a><span class="pln">            </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="335"></a><span class="pln">        </span><span class="pun">}</span></li><li><a name="336"></a><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li><a name="337"></a><span class="pln">    </span><span class="pun">}</span></li><li><a name="338"></a></li><li><a name="339"></a><span class="pun">}</span></li></ol><div class="footer">Powered by <a href="https://code.google.com/p/gitiles/">Gitiles</a></div></body></html>